name: CLI Batch Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # ── Shared build step ───────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - uses: astral-sh/setup-uv@v6
      - name: Install project
        run: uv sync && uv run maturin develop --release
      - name: Cache installed env
        uses: actions/cache/save@v4
        with:
          path: |
            .venv
            rust/target
          key: aloe-build-${{ github.sha }}

  # ── Matrix: exercise every CLI option ───────────────────────────
  cli-matrix:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Single-run variants ─────────────────────────────────
          - name: single-defaults
            args: --single
            check: sim_single.parquet

          - name: single-custom-params
            args: >-
              --single
              --dry-mass 25 --propellant-mass 80 --thrust 8000 --burn-time 12
              --drag-coeff 0.5 --ref-area 0.05 --gravity 9.79
              --wind-speed 8 --wind-speed-z 2 --air-density 1.1
            check: sim_single.parquet

          - name: single-spin-cant-delay
            args: >-
              --single
              --launch-delay 3 --spin-rate 720 --thrust-cant 2.5
            check: sim_single.parquet

          - name: single-no-sensors
            args: --single --no-sensors
            check: sim_single.parquet

          - name: single-default-with-filter
            args: --single
            check: sim_single.parquet

          - name: single-no-filter
            args: --single --no-filter
            check: sim_single.parquet

          - name: single-filter-report
            args: --single --filter-report
            check: sim_single.parquet

          - name: single-csv
            args: --single -f csv
            check: sim_single.csv
            format: csv

          - name: single-xlsx
            args: --single -f xlsx
            check: sim_single.xlsx
            format: xlsx

          - name: single-noise-seed
            args: --single --noise-scale 2.0 --seed 123
            check: sim_single.parquet

          - name: single-disable-bmi088
            args: --single --disable-sensor bmi088_accel bmi088_gyro
            check: sim_single.parquet

          - name: single-disable-adxl-baro
            args: --single --disable-sensor adxl375 ms5611
            check: sim_single.parquet

          - name: single-disable-mag-gps
            args: --single --disable-sensor lis3mdl lc29h
            check: sim_single.parquet

          - name: single-filter-geo
            args: >-
              --single
              --mag-declination 10.5 --home-lat 40.0 --home-lon -105.0 --home-alt 1600
            check: sim_single.parquet

          # ── Sweep variants ──────────────────────────────────────
          - name: sweep-no-filter
            args: --no-filter --sweep-steps 2 --sweep-params dry_mass thrust
            check: sweep_summary.csv

          - name: sweep-custom-params
            args: --sweep-steps 2 --sweep-params burn_time drag_coeff
            check: sweep_summary.csv

          - name: sweep-csv
            args: --sweep-steps 2 --sweep-params thrust -f csv
            check: sweep_summary.csv
            format: csv

          - name: sweep-with-filter-small
            args: --sweep-steps 2 --sweep-params thrust
            check: sweep_summary.csv

          # ── Full sweep (all features) — artifact uploaded ───────
          - name: full-sweep
            args: --filter-report
            check: sweep_summary.csv
            upload: true

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
      - uses: astral-sh/setup-uv@v6
      - name: Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .venv
            rust/target
          key: aloe-build-${{ github.sha }}
      - name: Ensure project installed
        run: uv sync && uv run maturin develop --release

      - name: Run CLI (${{ matrix.name }})
        run: uv run aloe cli ${{ matrix.args }} -o /tmp/aloe-${{ matrix.name }}

      - name: Verify outputs
        run: |
          ls -la /tmp/aloe-${{ matrix.name }}/
          test -e /tmp/aloe-${{ matrix.name }}/${{ matrix.check }}
          echo "✓ ${{ matrix.check }} exists"
          if [ -f /tmp/aloe-${{ matrix.name }}/sweep_summary.csv ]; then
            echo "── sweep_summary.csv ──"
            cat /tmp/aloe-${{ matrix.name }}/sweep_summary.csv
          fi

      - name: Upload sweep results
        if: matrix.upload && always()
        uses: actions/upload-artifact@v4
        with:
          name: full-sweep-results
          path: /tmp/aloe-${{ matrix.name }}/
          retention-days: 14
